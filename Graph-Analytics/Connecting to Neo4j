{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "c9841de3-c8c6-4d5a-a779-424f2cacb425",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Cleaned GEXF saved.\n"
     ]
    }
   ],
   "source": [
    "from lxml import etree\n",
    "\n",
    "def strip_namespaces(tree):\n",
    "    for elem in tree.iter():\n",
    "        if '}' in elem.tag:\n",
    "            elem.tag = elem.tag.split('}', 1)[1]\n",
    "    return tree\n",
    "\n",
    "# Load original GEXF\n",
    "tree = etree.parse(\"road_graph_with_intersections.gexf\")\n",
    "tree = strip_namespaces(tree)\n",
    "\n",
    "# Write cleaned file\n",
    "tree.write(\"cleaned.gexf\", encoding=\"utf-8\", xml_declaration=True)\n",
    "print(\"Cleaned GEXF saved.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "b41f3c8e-a560-4e9b-8a83-94dd136cfdad",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Loaded graph with 23421 nodes and 31948 edges.\n"
     ]
    }
   ],
   "source": [
    "import networkx as nx\n",
    "\n",
    "G = nx.read_gexf(\"cleaned.gexf\")\n",
    "print(f\"Loaded graph with {G.number_of_nodes()} nodes and {G.number_of_edges()} edges.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "2cbe5c37-d2e3-4855-9e4e-997207a63e15",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Loading GEXF...\n",
      "Graph loaded: 23421 nodes, 31948 edges\n",
      "Pushing nodes...\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "  0%|                                                                                        | 0/23421 [00:00<?, ?it/s]C:\\Users\\hurua\\AppData\\Local\\Temp\\ipykernel_8520\\1001241431.py:32: DeprecationWarning: write_transaction has been renamed to execute_write\n",
      "  session.write_transaction(create_node, str(node), dict(attrs))\n",
      "100%|████████████████████████████████████████████████████████████████████████████| 23421/23421 [06:22<00:00, 61.25it/s]\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Pushing edges (with reverse)...\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "  0%|                                                                                        | 0/31948 [00:00<?, ?it/s]C:\\Users\\hurua\\AppData\\Local\\Temp\\ipykernel_8520\\1001241431.py:37: DeprecationWarning: write_transaction has been renamed to execute_write\n",
      "  session.write_transaction(create_edge, str(u), str(v), edge_data)\n",
      "C:\\Users\\hurua\\AppData\\Local\\Temp\\ipykernel_8520\\1001241431.py:38: DeprecationWarning: write_transaction has been renamed to execute_write\n",
      "  session.write_transaction(create_edge, str(v), str(u), edge_data)  # reverse\n",
      "100%|████████████████████████████████████████████████████████████████████████████| 31948/31948 [19:33<00:00, 27.23it/s]"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "✅ Upload complete with bidirectional edges.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "\n"
     ]
    }
   ],
   "source": [
    "import networkx as nx\n",
    "from neo4j import GraphDatabase\n",
    "from tqdm import tqdm\n",
    "\n",
    "# === Config ===\n",
    "gexf_path = \"cleaned.gexf\"\n",
    "uri = \"bolt://localhost:7687\"\n",
    "user = \"neo4j\"\n",
    "password = \"neo4j_password\"  # update if needed\n",
    "\n",
    "# === Load graph ===\n",
    "print(\"Loading GEXF...\")\n",
    "G = nx.read_gexf(gexf_path)\n",
    "print(f\"Graph loaded: {G.number_of_nodes()} nodes, {G.number_of_edges()} edges\")\n",
    "\n",
    "# === Neo4j connection ===\n",
    "driver = GraphDatabase.driver(uri, auth=(user, password))\n",
    "\n",
    "def create_node(tx, node_id, props):\n",
    "    tx.run(\"MERGE (n:Intersection {id: $id}) SET n += $props\", id=node_id, props=props)\n",
    "\n",
    "def create_edge(tx, source, target, props):\n",
    "    tx.run(\"\"\"\n",
    "        MATCH (a:Intersection {id: $source}), (b:Intersection {id: $target})\n",
    "        MERGE (a)-[r:ROAD_TO]->(b)\n",
    "        SET r += $props\n",
    "    \"\"\", source=source, target=target, props=props)\n",
    "\n",
    "with driver.session() as session:\n",
    "    print(\"Pushing nodes...\")\n",
    "    for node, attrs in tqdm(G.nodes(data=True)):\n",
    "        session.write_transaction(create_node, str(node), dict(attrs))\n",
    "\n",
    "    print(\"Pushing edges (with reverse)...\")\n",
    "    for u, v, attrs in tqdm(G.edges(data=True)):\n",
    "        edge_data = dict(attrs)\n",
    "        session.write_transaction(create_edge, str(u), str(v), edge_data)\n",
    "        session.write_transaction(create_edge, str(v), str(u), edge_data)  # reverse\n",
    "        # optional: tag reverse edges with e.g., props[\"direction\"] = \"reverse\" if needed\n",
    "\n",
    "driver.close()\n",
    "print(\"✅ Upload complete with bidirectional edges.\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f9ecd6af-6811-43ba-8f3a-29e0bd9410b0",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.3"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
